<!DOCTYPE html>
<html>
<head>
    <title>Rivela Posizione</title>
</head>
<body>
<h1>La tua posizione attuale</h1>
<p id="location">Ottenendo la posizione...</p>

<script>
    function isIOS() {
        return /iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    function showPosition(position) {
        console.log("Posizione ottenuta: ", position);
        var locationElement = document.getElementById("location");
        var latitude = position.coords.latitude;
        var longitude = position.coords.longitude;

        locationElement.innerHTML = "Latitudine: " + latitude + "<br>Longitudine: " + longitude;

        // Invia la posizione al server
        fetch('https://alessiopgg.github.io/qrcodeProject/add_location', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                latitude: latitude,
                longitude: longitude
            })
        })
            .then(response => response.json())
            .then(data => console.log(data))
            .catch(error => console.error('Errore:', error));
    }

    function showError(error) {
        var locationElement = document.getElementById("location");
        switch(error.code) {
            case error.PERMISSION_DENIED:
                locationElement.innerHTML = "L'utente ha negato la richiesta di geolocalizzazione. Se stai utilizzando Safari su iPhone, vai in Impostazioni > Safari > Posizione e consenti l'accesso.";
                console.error("Errore: Permessi negati");
                break;
            case error.POSITION_UNAVAILABLE:
                locationElement.innerHTML = "Le informazioni sulla posizione non sono disponibili.";
                console.error("Errore: Posizione non disponibile");
                break;
            case error.TIMEOUT:
                locationElement.innerHTML = "La richiesta di ottenimento della posizione è scaduta.";
                console.error("Errore: Timeout");
                break;
            case error.UNKNOWN_ERROR:
                locationElement.innerHTML = "Si è verificato un errore sconosciuto.";
                console.error("Errore: Errore sconosciuto");
                break;
        }
    }

    function getLocation() {
        if (navigator.geolocation) {
            console.log("Richiesta di geolocalizzazione inviata.");
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            document.getElementById("location").innerHTML = "La geolocalizzazione non è supportata da questo browser.";
            console.error("Errore: Geolocalizzazione non supportata");
        }
    }

    window.onload = function() {
        if (isIOS()) {
            alert("Se stai usando Safari su iPhone, assicurati che i permessi di geolocalizzazione siano abilitati in Impostazioni > Safari > Posizione.");
        }
        getLocation();
    };
</script>
</body>
</html>
